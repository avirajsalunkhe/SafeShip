<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeShip | Neural Trace Engine v6.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        /**
         * 1. NEURAL HANDSHAKE
         * Correctly prioritizes runtime keys vs injected secrets.
         */
        const detectGeminiKey = () => {
            // Environment variable check
            if (typeof apiKey !== 'undefined' && apiKey !== null && apiKey !== "") return apiKey;
            
            // GitHub Placeholder check
            const placeholder = "__GEMINI_API_KEY__";
            if (placeholder && !placeholder.startsWith("__")) return placeholder;
            
            return ""; 
        };

        window.SAFESHIP_CONTEXT = {
            db: null,
            auth: null,
            appId: typeof __app_id !== 'undefined' ? __app_id : 'safeship-trace-v6',
            user: null,
            history: [],
            currentFiles: [],
            sessionKeys: {
                gemini: detectGeminiKey(),
                groq: "__GROQ_API_KEY__"
            }
        };

        // FIREBASE CONFIGURATION RECOVERY
        let firebaseConfig = null;
        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                firebaseConfig = typeof __firebase_config === 'string' ? JSON.parse(__firebase_config) : __firebase_config;
            } 
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                const rawInjected = '__FIREBASE_CONFIG_JSON__';
                if (rawInjected && !rawInjected.startsWith('__')) {
                    firebaseConfig = JSON.parse(rawInjected);
                }
            }
        } catch (e) {
            console.error("SafeShip Config Error:", e);
        }

        // INITIALIZATION SEQUENCE
        if (firebaseConfig && firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                window.SAFESHIP_CONTEXT.auth = auth;
                window.SAFESHIP_CONTEXT.db = db;

                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };

                onAuthStateChanged(auth, (user) => {
                    window.SAFESHIP_CONTEXT.user = user;
                    if (user) {
                        document.getElementById('userIdText').innerText = user.uid;
                        loadHistory(user.uid);
                    }
                });
                initAuth();
            } catch (e) { console.error("Firebase Init Failed:", e); }
        } else {
            console.warn("Persistence Node Offline.");
            setTimeout(() => {
                const sl = document.getElementById('statusLabel');
                if (sl) sl.innerText = "Persistence Offline";
            }, 500);
        }

        function loadHistory(userId) {
            const { db, appId } = window.SAFESHIP_CONTEXT;
            if (!db) return;
            const historyPath = collection(db, 'artifacts', appId, 'users', userId, 'audits');
            onSnapshot(historyPath, (snapshot) => {
                const audits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => b.timestamp?.seconds - a.timestamp?.seconds);
                window.SAFESHIP_CONTEXT.history = audits;
                renderHistory();
            }, (err) => console.error("History Stream error:", err));
        }

        window.saveAuditToCloud = async (auditData) => {
            const { db, user, appId } = window.SAFESHIP_CONTEXT;
            if (!db || !user) return;
            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'audits'), {
                ...auditData,
                timestamp: serverTimestamp()
            });
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap');
        :root { --emerald-glow: rgba(16, 185, 129, 0.15); --bg-deep: #020203; }
        body { font-family: 'Space Grotesk', sans-serif; background-color: var(--bg-deep); color: #f4f4f5; overflow-x: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }
        .neon-border { box-shadow: 0 0 20px var(--emerald-glow); }
        @keyframes scanline { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }
        .scanline::after { content: ""; position: absolute; inset: 0; background: linear-gradient(to bottom, transparent, rgba(16, 185, 129, 0.05), transparent); animation: scanline 4s linear infinite; pointer-events: none; }
        @keyframes pulse-link { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.95); } }
        .animate-link { animation: pulse-link 2s infinite ease-in-out; }
    </style>
</head>
<body class="selection:bg-emerald-500/30">
    <div class="fixed -top-24 -left-24 w-96 h-96 bg-emerald-600/10 rounded-full blur-[120px] pointer-events-none"></div>
    <div class="flex h-screen overflow-hidden">
        <aside class="w-72 border-r border-zinc-800/50 bg-black/40 flex flex-col z-50">
            <div class="p-6 border-b border-zinc-800/50 flex items-center gap-3">
                <div class="w-8 h-8 bg-emerald-500 rounded-lg flex items-center justify-center neon-border"><i data-lucide="shield-check" class="w-5 h-5 text-black"></i></div>
                <h1 class="text-lg font-bold tracking-tight">SafeShip <span class="text-emerald-500">v6</span></h1>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                <span class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest px-2">History Traces</span>
                <div id="historyContainer" class="space-y-2"></div>
            </div>
            <div class="p-4 border-t border-zinc-800/50">
                <div class="flex items-center gap-3 p-3 bg-zinc-900/50 rounded-xl border border-zinc-800/50">
                    <div class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center"><i data-lucide="user" class="w-4 h-4 text-zinc-400"></i></div>
                    <div class="flex flex-col"><span class="text-[10px] text-zinc-500 uppercase font-black">Secure ID</span><span id="userIdText" class="text-[10px] font-mono text-emerald-500 truncate w-32">Connecting...</span></div>
                </div>
            </div>
        </aside>
        <main class="flex-1 overflow-y-auto relative flex flex-col">
            <nav class="h-16 border-b border-zinc-800/50 flex items-center justify-between px-8 bg-black/20 backdrop-blur-md sticky top-0 z-40">
                <div class="flex gap-8">
                    <button onclick="setMode('url')" id="modeTab-url" class="text-xs font-black uppercase tracking-widest text-emerald-500 border-b-2 border-emerald-500 h-16 transition-all">URL Scan</button>
                    <button onclick="setMode('code')" id="modeTab-code" class="text-xs font-black uppercase tracking-widest text-zinc-500 hover:text-zinc-200 h-16 transition-all">SAST Multi-File</button>
                </div>
                <div class="flex items-center gap-4">
                    <div id="neuralStatus" class="flex items-center gap-2 px-4 py-2 bg-zinc-900 rounded-xl border border-zinc-800">
                        <div id="statusPulse" class="w-2 h-2 rounded-full bg-zinc-700"></div>
                        <span id="statusLabel" class="text-[10px] font-black uppercase tracking-widest text-zinc-500">Awaiting Secrets</span>
                    </div>
                </div>
            </nav>
            <div class="p-8 max-w-5xl mx-auto w-full space-y-8">
                <div id="urlSection" class="space-y-4">
                    <h2 class="text-4xl font-bold tracking-tighter">Deep <span class="text-emerald-500">Live</span> Probe.</h2>
                    <div class="flex gap-2">
                        <input type="text" id="urlInput" placeholder="https://target.com" class="flex-1 bg-zinc-900/50 border border-zinc-800 rounded-2xl py-4 px-6 text-sm focus:border-emerald-500 outline-none">
                        <button onclick="startAudit()" class="bg-emerald-500 text-black font-black px-8 rounded-2xl">INITIATE</button>
                    </div>
                </div>
                <div id="codeSection" class="hidden space-y-4">
                    <h2 class="text-4xl font-bold tracking-tighter">Multi-File <span class="text-emerald-500">SAST</span>.</h2>
                    <div class="border-2 border-dashed border-zinc-800 rounded-3xl p-12 text-center bg-zinc-900/10 cursor-pointer" onclick="document.getElementById('fileInput').click()">
                        <input type="file" id="fileInput" multiple class="hidden" onchange="handleFiles(event)">
                        <p class="text-sm font-bold">Click to upload source trace files</p>
                    </div>
                    <div id="fileList" class="flex flex-wrap gap-2"></div>
                    <button id="codeAuditBtn" onclick="startAudit()" class="w-full bg-white text-black font-black py-4 rounded-2xl disabled:opacity-50" disabled>ANALYZE LOGIC</button>
                </div>
                <div id="resultsArea">
                    <div id="idleState" class="h-[400px] border border-zinc-800/50 rounded-[2.5rem] flex flex-col items-center justify-center bg-black/20 scanline relative overflow-hidden"><i data-lucide="activity" class="w-12 h-12 text-zinc-800 mb-4 animate-pulse"></i><p class="text-[10px] font-black text-zinc-600 uppercase tracking-widest">Awaiting Signal</p></div>
                    <div id="loadingState" class="hidden h-[400px] flex flex-col items-center justify-center"><p id="loadingPhase" class="text-xs font-mono text-emerald-500 uppercase tracking-widest animate-pulse">Initializing...</p></div>
                    <div id="contentState" class="hidden space-y-8"></div>
                </div>
            </div>
        </main>
    </div>
    <script>
        let auditMode = 'url';
        function autoConfigureNeuralNodes() {
            const keys = window.SAFESHIP_CONTEXT.sessionKeys;
            const sp = document.getElementById('statusPulse');
            const sl = document.getElementById('statusLabel');
            if (keys.gemini && !keys.gemini.startsWith("__")) {
                sp.className = "w-2 h-2 rounded-full bg-emerald-500 animate-link";
                sl.innerText = "Neural Linked"; sl.className = "text-[10px] font-black uppercase text-emerald-500";
            } else {
                sp.className = "w-2 h-2 rounded-full bg-rose-500";
                sl.innerText = "Neural Offline"; sl.className = "text-[10px] font-black uppercase text-rose-500";
            }
        }
        function setMode(m) { auditMode = m; document.getElementById('urlSection').classList.toggle('hidden', m !== 'url'); document.getElementById('codeSection').classList.toggle('hidden', m !== 'code'); }
        function handleFiles(e) {
            const files = Array.from(e.target.files);
            const container = document.getElementById('fileList'); container.innerHTML = '';
            window.SAFESHIP_CONTEXT.currentFiles = [];
            files.forEach(file => {
                const r = new FileReader();
                r.onload = (ev) => {
                    window.SAFESHIP_CONTEXT.currentFiles.push({ name: file.name, content: ev.target.result });
                    const d = document.createElement('div'); d.className = "bg-zinc-900 border border-zinc-800 px-3 py-1.5 rounded-lg text-[10px] flex items-center gap-2";
                    d.innerHTML = `<i data-lucide="file-code" class="w-3 h-3 text-emerald-500"></i> ${file.name}`; container.appendChild(d);
                    lucide.createIcons(); document.getElementById('codeAuditBtn').disabled = false;
                }; r.readAsText(file);
            });
        }
        async function startAudit() {
            const ld = document.getElementById('loadingState'), id = document.getElementById('idleState'), ct = document.getElementById('contentState'), ph = document.getElementById('loadingPhase');
            id.classList.add('hidden'); ct.classList.add('hidden'); ld.classList.remove('hidden');
            try {
                const keys = window.SAFESHIP_CONTEXT.sessionKeys;
                if (!keys.gemini || keys.gemini.startsWith("__")) throw new Error("Neural Nodes Inactive. Set GEMINI_API_KEY.");
                let data;
                if (auditMode === 'url') {
                    const url = document.getElementById('urlInput').value.trim(); if(!url) throw new Error("URL Required");
                    ph.innerText = "Tracing Infrastructure...";
                    const sc = await simulateScrape(url);
                    data = await callGemini(`Audit website: ${url}. Context: ${sc}`); data.target = url;
                } else {
                    ph.innerText = "Scanning Repository...";
                    const code = window.SAFESHIP_CONTEXT.currentFiles.map(f => `File: ${f.name}\n${f.content}`).join('\n\n');
                    data = await callGemini(`SAST Audit: ${code}`); data.target = "Repo Trace";
                }
                await window.saveAuditToCloud(data); renderResults(data);
            } catch (err) { alert(err.message); ld.classList.add('hidden'); id.classList.remove('hidden'); }
        }
        async function simulateScrape(u) {
            try { const r = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(u)}`); const d = await r.json(); return d.contents.substring(0, 4000); }
            catch (e) { return "Scrape Restricted."; }
        }
        async function callGemini(p) {
            const k = window.SAFESHIP_CONTEXT.sessionKeys.gemini;
            const u = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${k}`;
            const pay = { contents: [{ parts: [{ text: p }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { score: { type: "NUMBER" }, summary: { type: "STRING" }, findings: { type: "ARRAY", items: { type: "OBJECT", properties: { title: { type: "STRING" }, severity: { type: "STRING" }, description: { type: "STRING" }, location: { type: "STRING" }, fix: { type: "STRING" } } } } } } } };
            const r = await fetch(u, { method: 'POST', body: JSON.stringify(pay) }); const d = await r.json();
            if (d.error) throw new Error(d.error.message); return JSON.parse(d.candidates[0].content.parts[0].text);
        }
        function renderResults(d) {
            const ct = document.getElementById('contentState'); document.getElementById('loadingState').classList.add('hidden'); ct.classList.remove('hidden');
            ct.innerHTML = `
                <div class="flex justify-between items-end"><div><span class="text-[10px] font-black uppercase text-zinc-500 tracking-widest">Verdict</span><h3 class="text-6xl font-bold tracking-tighter">${d.score}%</h3></div></div>
                <div class="p-6 bg-emerald-500/5 border border-emerald-500/10 rounded-[2rem] text-sm text-zinc-400">${d.summary}</div>
                <div class="space-y-4">${d.findings.map(f => `
                    <div class="bg-zinc-900/40 border border-zinc-800/50 rounded-2xl p-6 hover:border-zinc-700 transition-all">
                        <h4 class="font-bold text-white mb-2">${f.title}</h4><p class="text-xs text-zinc-500 font-mono mb-2">${f.location}</p><p class="text-sm text-zinc-400 mb-4">${f.description}</p>
                        <div class="p-4 bg-black/40 rounded-xl border border-emerald-500/10"><p class="text-[9px] font-black text-emerald-500 uppercase tracking-widest mb-2">Neural Fix</p><code class="text-xs font-mono text-emerald-400 whitespace-pre-wrap">${f.fix}</code></div>
                    </div>`).join('')}</div>`; lucide.createIcons();
        }
        function renderHistory() {
            const h = window.SAFESHIP_CONTEXT.history, c = document.getElementById('historyContainer');
            if (h.length === 0) { c.innerHTML = `<div class="p-4 text-center text-zinc-700 text-[10px] uppercase font-bold">No Records Found</div>`; return; }
            c.innerHTML = h.map(i => `<div onclick='renderResults(${JSON.stringify(i)})' class="p-3 bg-zinc-900/30 border border-zinc-800/50 rounded-xl hover:border-emerald-500/50 cursor-pointer transition-all"><div class="flex justify-between items-center mb-1"><span class="text-[10px] font-bold text-emerald-500">${i.score}%</span><span class="text-[9px] text-zinc-600 font-mono">${i.timestamp ? new Date(i.timestamp.seconds * 1000).toLocaleDateString() : 'N/A'}</span></div><p class="text-[11px] font-medium text-zinc-400 truncate">${i.target || 'Trace'}</p></div>`).join('');
        }
        window.onload = () => { lucide.createIcons(); setMode('url'); autoConfigureNeuralNodes(); };
    </script>
</body>
</html>
