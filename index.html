<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeShip | Neural Trace Engine v6.2.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!--
    ╔══════════════════════════════════════════════════════════════╗
    ║  INJECTED BY DEPLOY PIPELINE — DO NOT EDIT THESE LINES      ║
    ║  These are replaced at build time by deploy.yml              ║
    ╚══════════════════════════════════════════════════════════════╝
    -->
    <script>
        // These values are injected by the GitHub Actions deploy pipeline.
        // The placeholders below are replaced with real secret values during build.
        // They are plain JS variables so the module script below can read them.
        var INJECTED_GEMINI_KEY = "AIzaSyC6TvnhX04iXxg3e8BHsSBXByPVpUsfPAA";
        var INJECTED_GROQ_KEY   = "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";
        var INJECTED_FIREBASE   = '{
  apiKey: "AIzaSyB_d7N2FTeD0mrO-odMx2ajwtVIHOOKig0",
  authDomain: "safeship-trace.firebaseapp.com",
  projectId: "safeship-trace",
  storageBucket: "safeship-trace.firebasestorage.app",
  messagingSenderId: "538497558292",
  appId: "1:538497558292:web:0e512311b343b5ec1f0401",
  measurementId: "G-Z097L20KCF"
}';
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- INTERNAL TELEMETRY ---
        window.neuralTelemetry = (component, message, data = null) => {
            const time = new Date().toLocaleTimeString();
            console.log(`%c[NEURAL] [${time}] [${component}] %c${message}`, "color: #10b981; font-weight: bold;", "color: #a1a1aa;", data || "");
        };

        // ── KEY RESOLUTION ─────────────────────────────────────────────────────
        // The deploy.yml pipeline replaces the __PLACEHOLDER__ strings inside the
        // INJECTED_* variables above with real secret values.
        // We check: if the value still looks like a placeholder → key not injected.
        const isInjected = (val) => val && val !== "" && !val.startsWith("__") && !val.endsWith("__");

        const getGeminiKey = () => isInjected(window.INJECTED_GEMINI_KEY) ? window.INJECTED_GEMINI_KEY : null;
        const getGroqKey   = () => isInjected(window.INJECTED_GROQ_KEY)   ? window.INJECTED_GROQ_KEY   : null;

        const getFirebaseConfig = () => {
            const raw = window.INJECTED_FIREBASE;
            if (!isInjected(raw)) return null;
            try {
                return typeof raw === 'object' ? raw : JSON.parse(raw);
            } catch (e) {
                neuralTelemetry("Firebase", "Config parse error", e);
                return null;
            }
        };
        // ───────────────────────────────────────────────────────────────────────

        const appId = 'safeship-trace-v6';

        window.SAFESHIP_CONTEXT = {
            db: null, auth: null,
            appId: appId,
            user: null, history: [], currentFiles: [],
            sessionKeys: {
                gemini: getGeminiKey(),
                groq:   getGroqKey()
            }
        };

        // --- FIREBASE INITIALIZATION ---
        const initFirebase = async () => {
            const config = getFirebaseConfig();

            if (config && config.apiKey) {
                try {
                    const app  = initializeApp(config);
                    const auth = getAuth(app);
                    const db   = getFirestore(app);

                    window.SAFESHIP_CONTEXT.auth = auth;
                    window.SAFESHIP_CONTEXT.db   = db;

                    onAuthStateChanged(auth, (user) => {
                        window.SAFESHIP_CONTEXT.user = user;
                        const uidEl = document.getElementById('userIdText');
                        if (uidEl) uidEl.innerText = user ? user.uid : "Connecting...";
                        if (user) {
                            updateStatusUI("Cloud Linked", "text-emerald-500");
                            loadHistory(user.uid);
                        }
                    });

                    updateStatusUI("Connecting Node", "text-zinc-500");
                    await signInAnonymously(auth);
                    neuralTelemetry("Persistence", "Uplink Established.");
                } catch (e) {
                    neuralTelemetry("Firebase", "Initialization Error", e);
                    updateStatusUI("Persistence Offline", "text-rose-500");
                }
            } else {
                neuralTelemetry("Persistence", "STANDALONE MODE: Local session only.");
                updateStatusUI("Standalone Mode", "text-zinc-500");
            }
        };

        function updateStatusUI(label, colorClass) {
            const sl = document.getElementById('statusLabel');
            const sp = document.getElementById('statusPulse');
            if (sl) {
                sl.innerText = label;
                sl.className = `text-[10px] font-black uppercase tracking-widest ${colorClass}`;
            }
            if (sp) {
                if (label.includes("Linked") || label.includes("Active")) {
                    sp.className = "w-2 h-2 rounded-full bg-emerald-500 animate-pulse";
                } else if (label.includes("Fallback")) {
                    sp.className = "w-2 h-2 rounded-full bg-amber-500 animate-pulse";
                } else if (label.includes("Offline") || label.includes("Error")) {
                    sp.className = "w-2 h-2 rounded-full bg-rose-500";
                } else {
                    sp.className = "w-2 h-2 rounded-full bg-zinc-700";
                }
            }
        }

        function loadHistory(userId) {
            const { db, appId } = window.SAFESHIP_CONTEXT;
            if (!db) return;
            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'audits'), (snap) => {
                const audits = snap.docs.map(d => ({ id: d.id, ...d.data() }))
                    .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                window.SAFESHIP_CONTEXT.history = audits;
                renderHistory();
            }, (err) => {
                neuralTelemetry("History", "Access restricted. Verify Firestore rules.", err);
            });
        }

        window.saveAuditToCloud = async (auditData) => {
            const { db, user, appId } = window.SAFESHIP_CONTEXT;
            if (!db || !user) return;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'audits'), {
                    ...auditData, timestamp: serverTimestamp()
                });
            } catch(e) { neuralTelemetry("Storage", "Write Error", e); }
        };

        window.deleteAudit = async (auditId) => {
            const { db, user, appId } = window.SAFESHIP_CONTEXT;
            if (!db || !user) return;
            try { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'audits', auditId)); }
            catch (e) { neuralTelemetry("Storage", "Delete Error", e); }
        };

        window.onload = () => {
            lucide.createIcons();
            initFirebase();
            autoConfigureNodes();
        };

        function autoConfigureNodes() {
            const gemini = getGeminiKey();
            const groq   = getGroqKey();
            window.SAFESHIP_CONTEXT.sessionKeys.gemini = gemini;
            window.SAFESHIP_CONTEXT.sessionKeys.groq   = groq;

            const sl = document.getElementById('statusLabel');
            if (gemini) {
                neuralTelemetry("Engine", "Gemini Node Handshake Success.");
                if (sl && !sl.innerText.includes("Cloud")) updateStatusUI("Neural Active", "text-emerald-500");
            } else if (groq) {
                neuralTelemetry("Engine", "Gemini Node Missing. Falling back to Groq Handshake.");
                if (sl && !sl.innerText.includes("Cloud")) updateStatusUI("Groq Fallback", "text-amber-500");
            } else {
                neuralTelemetry("Engine", "CRITICAL: No Neural Nodes linked. Check GitHub Secrets & deploy pipeline.");
                updateStatusUI("No Keys Found", "text-rose-500");
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'Space Grotesk', sans-serif; background-color: #020203; color: #f4f4f5; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .neon-glow { box-shadow: 0 0 20px rgba(16, 185, 129, 0.1); }
        .scanline::after { content: ""; position: absolute; inset: 0; background: linear-gradient(to bottom, transparent, rgba(16, 185, 129, 0.03), transparent); animation: scan 4s linear infinite; pointer-events: none; }
        @keyframes scan { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }
    </style>
</head>
<body class="selection:bg-emerald-500/30">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-72 border-r border-zinc-800/50 bg-black/40 flex flex-col z-50">
            <div class="p-6 border-b border-zinc-800/50 flex items-center gap-3">
                <div class="w-8 h-8 bg-emerald-500 rounded-lg flex items-center justify-center neon-glow"><i data-lucide="shield-check" class="w-5 h-5 text-black"></i></div>
                <h1 class="text-lg font-bold">SafeShip <span class="text-emerald-500 text-sm">v6.2.4</span></h1>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                <span class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest px-2">History Traces</span>
                <div id="historyContainer" class="space-y-2"></div>
            </div>
            <div class="p-4 border-t border-zinc-800/50">
                <div class="flex items-center gap-3 p-3 bg-zinc-900/50 rounded-xl border border-zinc-800/50">
                    <div class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center"><i data-lucide="user" class="w-4 h-4 text-zinc-400"></i></div>
                    <div class="flex flex-col"><span class="text-[10px] text-zinc-500 uppercase font-black">Node ID</span><span id="userIdText" class="text-[10px] font-mono text-emerald-500 truncate w-32 tracking-tighter">Connecting...</span></div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto relative flex flex-col">
            <nav class="h-16 border-b border-zinc-800/50 flex items-center justify-between px-8 bg-black/20 backdrop-blur-md sticky top-0 z-40">
                <div class="flex gap-8">
                    <button onclick="setMode('url')" id="tab-url" class="text-xs font-black uppercase tracking-widest text-emerald-500 border-b-2 border-emerald-500 h-16">URL Scan</button>
                    <button onclick="setMode('code')" id="tab-code" class="text-xs font-black uppercase tracking-widest text-zinc-500 h-16">SAST Audit</button>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 px-4 py-2 bg-zinc-900 rounded-xl border border-zinc-800">
                        <div id="statusPulse" class="w-2 h-2 rounded-full bg-zinc-700"></div>
                        <span id="statusLabel" class="text-[10px] font-black uppercase tracking-widest text-zinc-500">Node Standby</span>
                    </div>
                </div>
            </nav>

            <div class="p-8 max-w-5xl mx-auto w-full space-y-8">
                <div id="urlSection" class="space-y-4">
                    <h2 class="text-4xl font-bold tracking-tighter">Deep <span class="text-emerald-500">Live</span> Probe.</h2>
                    <div class="flex gap-2">
                        <input type="text" id="urlInput" placeholder="https://target-endpoint.com" class="flex-1 bg-zinc-900/50 border border-zinc-800 rounded-2xl py-4 px-6 text-sm outline-none focus:border-emerald-500/50">
                        <button onclick="startAudit()" class="bg-emerald-500 text-black font-black px-8 rounded-2xl">INITIATE</button>
                    </div>
                </div>

                <div id="codeSection" class="hidden space-y-4">
                    <h2 class="text-4xl font-bold tracking-tighter">Neural <span class="text-emerald-500">SAST</span>.</h2>
                    <div class="border-2 border-dashed border-zinc-800 rounded-3xl p-12 text-center bg-zinc-900/10 cursor-pointer hover:bg-zinc-900/20" onclick="document.getElementById('fileInput').click()">
                        <input type="file" id="fileInput" multiple class="hidden" onchange="handleFiles(event)">
                        <i data-lucide="upload-cloud" class="w-8 h-8 mx-auto mb-4 text-zinc-700"></i>
                        <p class="text-sm font-bold">Drop files or click to upload</p>
                    </div>
                    <div id="fileList" class="flex flex-wrap gap-2"></div>
                    <button id="codeAuditBtn" onclick="startAudit()" class="w-full bg-white text-black font-black py-4 rounded-2xl disabled:opacity-50" disabled>ANALYZE LOGIC</button>
                </div>

                <div id="resultsArea">
                    <div id="idleState" class="h-[300px] border border-zinc-800/30 rounded-[2.5rem] flex flex-col items-center justify-center bg-black/20 scanline relative overflow-hidden">
                        <i data-lucide="activity" class="w-10 h-10 text-zinc-800 mb-4"></i>
                        <p class="text-[10px] font-black text-zinc-600 uppercase tracking-widest">Awaiting Signal</p>
                    </div>
                    <div id="loadingState" class="hidden h-[300px] flex flex-col items-center justify-center">
                        <p id="loadingPhase" class="text-xs font-mono text-emerald-500 uppercase tracking-widest animate-pulse">Syncing Nodes...</p>
                    </div>
                    <div id="contentState" class="hidden space-y-8"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let auditMode = 'url';

        function setMode(m) {
            auditMode = m;
            document.getElementById('urlSection').classList.toggle('hidden', m !== 'url');
            document.getElementById('codeSection').classList.toggle('hidden', m !== 'code');
            document.getElementById('tab-url').className = m === 'url' ? "text-xs font-black uppercase tracking-widest text-emerald-500 border-b-2 border-emerald-500 h-16" : "text-xs font-black uppercase tracking-widest text-zinc-500 h-16";
            document.getElementById('tab-code').className = m === 'code' ? "text-xs font-black uppercase tracking-widest text-emerald-500 border-b-2 border-emerald-500 h-16" : "text-xs font-black uppercase tracking-widest text-zinc-500 h-16";
        }

        function handleFiles(e) {
            const files = Array.from(e.target.files), c = document.getElementById('fileList'); c.innerHTML = '';
            window.SAFESHIP_CONTEXT.currentFiles = [];
            files.forEach(file => {
                const r = new FileReader(); r.onload = (ev) => {
                    window.SAFESHIP_CONTEXT.currentFiles.push({ name: file.name, content: ev.target.result });
                    const d = document.createElement('div'); d.className = "bg-zinc-900 border border-zinc-800 px-3 py-1.5 rounded-lg text-[10px] flex items-center gap-2";
                    d.innerHTML = `<i data-lucide="file-code" class="w-3 h-3 text-emerald-500"></i> ${file.name}`; c.appendChild(d);
                    lucide.createIcons(); document.getElementById('codeAuditBtn').disabled = false;
                }; r.readAsText(file);
            });
        }

        async function startAudit() {
            const ld = document.getElementById('loadingState'), id = document.getElementById('idleState'), ct = document.getElementById('contentState'), ph = document.getElementById('loadingPhase');
            id.classList.add('hidden'); ct.classList.add('hidden'); ld.classList.remove('hidden');

            try {
                const keys = window.SAFESHIP_CONTEXT.sessionKeys;
                if (!keys.gemini && !keys.groq) throw new Error("No Neural Node online. Check GitHub Secrets or deploy pipeline logs.");

                let targetLabel, prompt;
                if (auditMode === 'url') {
                    const u = document.getElementById('urlInput').value.trim(); if(!u) throw new Error("URL Required");
                    targetLabel = u;
                    ph.innerText = "Intercepting headers...";
                    prompt = `Conduct a security audit of this URL: ${u}`;
                } else {
                    targetLabel = "Repository Trace";
                    ph.innerText = "Analyzing semantic flow...";
                    prompt = "SAST Audit Report for these files:\n" + window.SAFESHIP_CONTEXT.currentFiles.map(f => `File: ${f.name}\n${f.content}`).join('\n\n');
                }

                const data = await callNeuralNode(prompt);
                data.target = targetLabel;
                await window.saveAuditToCloud(data);
                renderResults(data);
            } catch (err) {
                window.neuralTelemetry("Error", err.message);
                ld.classList.add('hidden'); id.classList.remove('hidden');
                alert(err.message);
            }
        }

        async function callNeuralNode(prompt) {
            const keys = window.SAFESHIP_CONTEXT.sessionKeys;
            const fullPrompt = prompt + "\nRespond ONLY in valid JSON: {score: number, summary: string, findings: [{title: string, severity: string, description: string, location: string, fix: string}]}";

            if (keys.gemini) {
                try {
                    window.neuralTelemetry("Engine", "Initiating Gemini Trace...");
                    return await callGeminiAPI(keys.gemini, fullPrompt);
                } catch (e) {
                    if (keys.groq) {
                        window.neuralTelemetry("Engine", "Gemini Node Failure. Switching to Groq Fallback...");
                        return await callGroqAPI(keys.groq, fullPrompt);
                    }
                    throw e;
                }
            } else if (keys.groq) {
                window.neuralTelemetry("Engine", "Using Groq Fallback Node.");
                return await callGroqAPI(keys.groq, fullPrompt);
            }
            throw new Error("Handshake Failed: No valid API keys.");
        }

        async function callGeminiAPI(key, prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType: "application/json" }
                })
            });
            if (!res.ok) {
                const errText = await res.text();
                throw new Error(`Gemini Service Error ${res.status}: ${errText}`);
            }
            const data = await res.json();
            return JSON.parse(data.candidates[0].content.parts[0].text);
        }

        async function callGroqAPI(key, prompt) {
            const url = "https://api.groq.com/openai/v1/chat/completions";
            const res = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${key}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: "llama-3.3-70b-versatile",
                    messages: [{ role: "user", content: prompt }],
                    response_format: { type: "json_object" }
                })
            });
            if (!res.ok) {
                const errText = await res.text();
                throw new Error(`Groq Service Error ${res.status}: ${errText}`);
            }
            const data = await res.json();
            return JSON.parse(data.choices[0].message.content);
        }

        function renderResults(d) {
            const ct = document.getElementById('contentState');
            document.getElementById('loadingState').classList.add('hidden');
            ct.classList.remove('hidden');
            ct.innerHTML = `
                <div class="flex justify-between items-end">
                    <div><span class="text-[10px] font-black uppercase text-zinc-500 tracking-widest">Security Score</span><h3 class="text-6xl font-bold tracking-tighter">${d.score}%</h3></div>
                    <button onclick="resetUI()" class="p-3 bg-zinc-900 border border-zinc-800 rounded-xl text-zinc-500 hover:text-white"><i data-lucide="refresh-cw"></i></button>
                </div>
                <div class="p-6 bg-emerald-500/5 border border-emerald-500/10 rounded-3xl text-sm text-zinc-400 leading-relaxed">${d.summary}</div>
                <div class="space-y-4">${d.findings.map(f => `
                    <div class="bg-zinc-900/40 border border-zinc-800/50 rounded-2xl p-6">
                        <div class="flex justify-between items-start mb-2"><h4 class="font-bold text-white">${f.title}</h4><span class="text-[10px] px-2 py-0.5 rounded bg-black border border-zinc-800 text-zinc-500 font-mono">${f.severity.toUpperCase()}</span></div>
                        <p class="text-xs text-zinc-500 font-mono mb-2">${f.location}</p>
                        <p class="text-sm text-zinc-400 mb-4">${f.description}</p>
                        <div class="p-4 bg-black/60 rounded-xl border border-emerald-500/10">
                            <p class="text-[9px] font-black text-emerald-500 uppercase tracking-widest mb-1">Recommended Fix</p>
                            <code class="text-xs font-mono text-emerald-400 whitespace-pre-wrap">${f.fix}</code>
                        </div>
                    </div>`).join('')}</div>`;
            lucide.createIcons();
        }

        function renderHistory() {
            const h = window.SAFESHIP_CONTEXT.history, c = document.getElementById('historyContainer');
            if (!h.length) { c.innerHTML = '<p class="text-[10px] text-center text-zinc-700 mt-4 uppercase font-bold">No Trace History</p>'; return; }
            c.innerHTML = h.map(i => `
                <div class="group p-3 bg-zinc-900/30 border border-zinc-800/50 rounded-xl hover:border-emerald-500/30 cursor-pointer transition-all relative">
                    <div onclick='renderResults(${JSON.stringify(i).replace(/'/g, "&apos;")})' class="pr-6">
                        <div class="flex justify-between items-center mb-1"><span class="text-[10px] font-bold text-emerald-500">${i.score}%</span><span class="text-[8px] text-zinc-600 font-mono">${i.timestamp ? new Date(i.timestamp.seconds * 1000).toLocaleDateString() : 'Syncing'}</span></div>
                        <p class="text-[10px] font-medium text-zinc-400 truncate">${i.target}</p>
                    </div>
                    <button onclick="deleteAudit('${i.id}')" class="absolute right-2 top-1/2 -translate-y-1/2 text-zinc-700 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-all"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                </div>`).join('');
            lucide.createIcons();
        }

        window.resetUI = () => { location.reload(); };
    </script>
</body>
</html>
